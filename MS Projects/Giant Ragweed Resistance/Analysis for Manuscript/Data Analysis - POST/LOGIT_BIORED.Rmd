---
title: "LOGIT BIORED - WATERHEMP"
author: "Felipe A. Faleco"
date: "01/26/2021"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(car)
library(emmeans)
library(multcompView)
library(glmmTMB)
library(ggpubr)
library(Matrix)

```


# DATA

```{r}

data <- read.csv("All POST_Reduction.csv")

str(data)

data$run <- as.factor(data$run)

data$pop <- as.factor(data$pop)

data$Herbicide <- as.factor(data$Herbicide)

data$Rate <- as.factor(data$Rate)

data$rep <- as.factor(data$rep)

str(data)

```


# MODEL

```{r}

model <- glmmTMB(logit(bio_red) ~ Herbicide * Rate + (1|run) + (1|pop), data = data, family = "gaussian")


```


# SUMMARY

```{r, echo=TRUE}

summary(model)

```


# ANOVA

```{r, echo=TRUE}

glmmTMB:::Anova.glmmTMB(model, type = 3)

# when data is balanced, the factors are orthogonal, and types I, II and III all give the same results. Usually the hypothesis of interest is about the significance of one factor while controlling for the level of the other factors. This equates to using type II or III SS. In general, if there is no significant interaction effect, then type II is more powerful, and follows the principle of marginality. If interaction is present, then type II is inappropriate while type III can still be used, but results need to be interpreted with caution (in the presence of interactions, main effects are rarely interpretable).

```


# EMM & CLD

```{r, echo=TRUE}

emm_herb_rate <- emmeans(model, ~ Herbicide|Rate, adjust = "tukey", type = "response", contr = "pairwise")

emm_herb_rate

CLD_emm_herb_rate <- if(requireNamespace("multcomp")) {
    multcomp::cld(emm_herb_rate$emmeans, alpha = 0.05, Letters=letters, adjust="tukey", reversed = TRUE)}

CLD_emm_herb_rate

```


# PLOT

```{r, echo=TRUE}


plot(emm_herb_rate, adjust = "tukey", comparisons = F, CIs = T, alpha = 0.05) + 
  geom_point(size = 2) +
  geom_text(aes(label = c("b", "a", "b", 
                          "c", "a", "b")),
            vjust = -0.8, size = 4) +
  scale_x_continuous(breaks = c(0, 0.25, 0.50, 0.75, 1), limits = c(0, 1),
    labels = scales::percent_format(scale = 100, suffix = "")) +
  labs(#title = "Waterhemp Biomass Reduction - POST", 
       x = "Biomass reduction (%)", 
       y = "Herbicide") +
  facet_grid(~ Rate, labeller = label_both) +
  theme_bw() + 
  theme (plot.title = element_text(face = "bold", hjust = 0.5, size = 18, colour = "darkgreen"), 
         axis.title = element_text(face = "bold", size = 18, colour = "darkgreen"), 
         axis.text= element_text(face = "bold", size = 14, colour = "black"),
         strip.text = element_text(face = "bold", size = 14, colour = "black"),
         panel.spacing = unit(1.0, "lines")) +
  ggsave("LOGIT Tukey HSD_HERBxRATE.tiff", units="in", width = 10, height = 4, dpi = 600, compression = "lzw")


```


